import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { name, goal, goalAmount, age, targetAge, gender, riskLevel, monthlyContribution, years } = body;

    // Construct comprehensive Arabic prompt for detailed financial planning
    const prompt = `
ุฃูุดุฆ ุฎุทุฉ ูุงููุฉ ุดุงููุฉ ูููุตูุฉ ุจูุงุกู ุนูู ูุฐู ุงููุฏุฎูุงุช:
ุงูุงุณู: ${name}
ุงููุฏู: ${goal}
ุงููุจูุบ ุงููุณุชูุฏู: ${goalAmount} ุฑูุงู ุณุนูุฏู
ุงูุนูุฑ ุงูุญุงูู: ${age}
ุงูุนูุฑ ุงููุณุชูุฏู: ${targetAge}
ุงูุฌูุณ: ${gender}
ูุณุชูู ุงููุฎุงุทุฑุฉ: ${riskLevel}
ุงููุณุงููุฉ ุงูุดูุฑูุฉ ุงูููุชุฑุญุฉ: ${monthlyContribution} ุฑูุงู ุณุนูุฏู
ุงูุนููุฉ: SAR
ุงูุฃูู ุงูุฒููู: ${years} ุณูุฉ

**ูุงู ุฌุฏุงู: ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุญุณุงุจุงุช ูุงูุชูุตูุงุช ูุจููุฉ ุนูู ุงููุจูุบ ุงููุณุชูุฏู ุงููุญุฏุฏ (${goalAmount}) ูููุณ ุฃู ุฑูู ุขุฎุฑ.**

ุฃุฑูุฏ ุฎุทุฉ ูุงููุฉ ุดุงููุฉ ูููุตูุฉ ุฌุฏุงู ุชุชุถูู ุงูุฃูุณุงู ุงูุชุงููุฉ ุจุงูุชูุตูู:

๐ **1. ุงูููุฎุต ุงูุชูููุฐู**
- ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุฏู ุงููุงูู
- ุงููุจูุบ ุงููุทููุจ ูุงูุฅุทุงุฑ ุงูุฒููู
- ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุฑุฆูุณูุฉ ุงูููุชุฑุญุฉ
- ุงููุชุงุฆุฌ ุงููุชููุนุฉ

๐ฐ **2. ุชุญููู ุงููุฏู ุงููุงูู**
- ุชุญููู ููุตู ูุทุจูุนุฉ ุงููุฏู
- ุงูุชูููุฉ ุงููุชููุนุฉ ุจุงูุชูุตูู
- ุชุฃุซูุฑ ุงูุชุถุฎู ุนูู ุงูุชูููุฉ
- ููุงุฑูุฉ ุจุฃูุฏุงู ูุดุงุจูุฉ

๐ **3. ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุงุณุชุซูุงุฑูุฉ ุงูููุตูุฉ**
- ุชูุฒูุน ุงูุงุณุชุซูุงุฑุงุช ุญุณุจ ูุณุชูู ุงููุฎุงุทุฑุฉ
- ุฃููุงุน ุงูุงุณุชุซูุงุฑุงุช ุงูููุชุฑุญุฉ (ุตูุงุฏููุ ุฃุณููุ ุณูุฏุงุชุ ุนูุงุฑ)
- ุงููุณุจ ุงููุฆููุฉ ููู ููุน ุงุณุชุซูุงุฑ
- ูุนุฏูุงุช ุงูุนุงุฆุฏ ุงููุชููุนุฉ
- ุงุณุชุฑุงุชูุฌูุฉ ุฅุนุงุฏุฉ ุงูุชูุงุฒู

๐ธ **4. ุชุญููู ุงููุณุงููุฉ ุงูุดูุฑูุฉ**
- ุชูุตูู ุงููุณุงููุฉ ุงูุดูุฑูุฉ ุงููุทููุจุฉ
- ุฅููุงููุฉ ุฒูุงุฏุฉ ุงููุณุงููุฉ ุณูููุงู
- ุชุฃุซูุฑ ุงููุณุงููุงุช ุงูุฅุถุงููุฉ
- ุฎูุงุฑุงุช ุงููุณุงููุฉ ุงููุฑูุฉ
- ุญุณุงุจ ุงููููุฉ ุงููุณุชูุจููุฉ

๐ **5. ุงูุชููุนุงุช ูุงูุฅุณูุงุทุงุช ุงููุงููุฉ**
- ุฌุฏูู ููุตู ุจุงูููู ุงูุณููู ููุงุณุชุซูุงุฑ
- ุณููุงุฑูููุงุช ูุฎุชููุฉ (ูุชูุงุฆูุ ูุงูุนูุ ูุชุญูุธ)
- ุชุฃุซูุฑ ุชููุจุงุช ุงูุณูู
- ููุทุฉ ุงูุชุนุงุฏู ุงูุฒูููุฉ

๐ฆ **6. ุงูุฃุฏูุงุช ุงููุงููุฉ ุงูููุชุฑุญุฉ**
- ุตูุงุฏูู ุงูุงุณุชุซูุงุฑ ุงูุณุนูุฏูุฉ ุงูููุงุณุจุฉ
- ุญุณุงุจุงุช ุงูุงุฏุฎุงุฑ ุนุงููุฉ ุงูุนุงุฆุฏ
- ุจุฑุงูุฌ ุงูุงุฏุฎุงุฑ ุงูุญููููุฉ
- ุงูุชุฃููู ุนูู ุงูุงุณุชุซูุงุฑ

โ๏ธ **7. ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ ูุงูุชุญุฏูุงุช**
- ุงููุฎุงุทุฑ ุงููุญุชููุฉ ูููููุฉ ุชุฌูุจูุง
- ุงุณุชุฑุงุชูุฌูุงุช ุงูุชูููุน
- ุฎุทุท ุงูุทูุงุฑุฆ
- ุงูุชุฃููู ุถุฏ ุงููุฎุงุทุฑ ุงูุดุฎุตูุฉ

๐ **8. ุงูุฎุทุฉ ุงูุฒูููุฉ ุงูุชูุตูููุฉ**
**ุงูุณูุฉ ุงูุฃููู:**
- ุฎุทูุงุช ุงูุจุฏุงูุฉ ุงูููุฑูุฉ
- ูุชุญ ุงูุญุณุงุจุงุช ุงูุงุณุชุซูุงุฑูุฉ
- ุงูุจุฏุก ูู ุงูุงุณุชุซูุงุฑ ุงูุดูุฑู

**ุงูุณููุงุช 2-5:**
- ูุฑุงุฌุนุฉ ุงูุฃุฏุงุก ูู 6 ุฃุดูุฑ
- ุชุนุฏูู ุงูุงุณุชุฑุงุชูุฌูุฉ ุญุณุจ ุงูุญุงุฌุฉ
- ุฒูุงุฏุฉ ุงููุณุงููุงุช ุชุฏุฑูุฌูุงู

**ุงูุณููุงุช ุงูุฃุฎูุฑุฉ:**
- ุชูููู ุงููุฎุงุทุฑ ุชุฏุฑูุฌูุงู
- ุงูุชุญูู ููุงุณุชุซูุงุฑุงุช ุงููุญุงูุธุฉ
- ุชุฌููุฒ ุงูุณูููุฉ ูููุฏู

๐ **9. ูุคุดุฑุงุช ุงูุฃุฏุงุก ูุงููุชุงุจุนุฉ**
- ูุนุงููุฑ ููุงุณ ูุฌุงุญ ุงูุฎุทุฉ
- ููุงุท ุงููุฑุงุฌุนุฉ ุงูุฏูุฑูุฉ
- ูุชู ูููู ุชุนุฏูู ุงูุฎุทุฉ
- ุฃุฏูุงุช ุงููุชุงุจุนุฉ ุงูููุชุฑุญุฉ

๐ **10. ุงูุชุนููู ุงููุงูู ูุงูุชูุนูุฉ**
- ูุตุงุฆุญ ูุชุทููุฑ ุงูุซูุงูุฉ ุงููุงููุฉ
- ููุงุฑุฏ ุชุนููููุฉ ููุงุณุชุซูุงุฑ
- ููููุฉ ุชุนููู ุงูุทูู ูููุฉ ุงููุงู
- ุฅุดุฑุงู ุงูุทูู ูู ุงูุฎุทุฉ ุญุณุจ ุนูุฑู

๐ **11. ุจุฏุงุฆู ูุงุณุชุฑุงุชูุฌูุงุช ุฅุถุงููุฉ**
- ุฎูุงุฑุงุช ูู ุญุงูุฉ ุชุบูุฑ ุงูุฃูุฏุงู
- ุงุณุชุฑุงุชูุฌูุงุช ููุฃูุฏุงู ุงููุชุนุฏุฏุฉ
- ุทุฑู ุชุณุฑูุน ุงููุตูู ูููุฏู
- ุฎุทุท ุจุฏููุฉ ููุทูุงุฑุฆ

๐ **12. ูุงุฆูุฉ ุงููุฑุงุฌุนุฉ ูุงูุฎุทูุงุช ุงูุนูููุฉ**
- ูุงุฆูุฉ ุชูุตูููุฉ ุจุงูุฎุทูุงุช ุงููุทููุจุฉ
- ุงููุณุชูุฏุงุช ูุงูุฃูุฑุงู ุงููุทููุจุฉ
- ุงูุฌูุงุช ูุงูุจููู ุงูููุชุฑุญุฉ
- ุงูุชุทุจููุงุช ูุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ

ูุฌุจ ุฃู ุชููู ูู ููุทุฉ ููุตูุฉ ุฌุฏุงู ูุน:
- ุฃุฑูุงู ูุญุณุงุจุงุช ุฏูููุฉ
- ุฃูุซูุฉ ุนูููุฉ ูู ุงูุณูู ุงูุณุนูุฏู
- ูุฑุงุฌุน ููุฃุฏูุงุช ุงููุงููุฉ ุงููุนููุฉ
- ูุตุงุฆุญ ุนูููุฉ ูุงุจูุฉ ููุชุทุจูู
- ุชุญูููุงุช ุงูุชุตุงุฏูุฉ ูุงูุนูุฉ

ุงุฌุนู ุงูุฎุทุฉ ุดุงููุฉ ูููููุฉ ูุทูููุฉ ุจูุง ูููู ูุชููู ุฏูููุงู ูุงููุงู ููุงุณุชุซูุงุฑ.
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: "ุฃูุช ูุณุชุดุงุฑ ูุงูู ุฎุจูุฑ ููุนุชูุฏ ูุชุฎุตุต ูู ุงูุชุฎุทูุท ุงููุงูู ููุฃุทูุงู ูุงูุฃูุฏุงู ุทูููุฉ ุงููุฏู ูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ. ูุฏูู ุฎุจุฑุฉ 20+ ุณูุฉ ูู ุงูุฃุณูุงู ุงููุงููุฉ ุงูุณุนูุฏูุฉ. ูู ุจุฅูุดุงุก ุฎุทุท ูุงููุฉ ุดุงููุฉ ูููุตูุฉ ูููููุฉ ุฌุฏุงู ุจุงููุบุฉ ุงูุนุฑุจูุฉ. ูุฌุจ ุฃู ุชููู ุงูุฎุทุท ุทูููุฉ ูุชุญุชูู ุนูู ุชุญูููุงุช ุนูููุฉ ูุฃุฑูุงู ุฏูููุฉ ูุชูุตูุงุช ุนูููุฉ ูุงุจูุฉ ููุชุทุจูู ููุฑุงู. ุงูุชุจ ุฎุทุฉ ููุตูุฉ ูุง ุชูู ุนู 3000 ูููุฉ ูุน ุฌุฏุงูู ูุญุณุงุจุงุช ูุงููุฉ ุฏูููุฉ."
        },
        {
          role: "user",
          content: prompt
        }
      ],
      max_tokens: 16000,
      temperature: 0.7,
    });

    const planContent = completion.choices[0]?.message?.content || '';

    // Return the generated plan
    return NextResponse.json({
      success: true,
      plan: {
        name,
        goal,
        goalAmount,
        age: parseInt(age),
        targetAge: parseInt(targetAge),
        gender,
        riskLevel,
        monthlyContribution,
        years,
        content: planContent,
        generatedAt: new Date().toISOString()
      }
    });

  } catch (error) {
    console.error('Error generating financial plan:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to generate financial plan' },
      { status: 500 }
    );
  }
}