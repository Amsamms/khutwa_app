import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { name, goal, goalAmount, age, targetAge, gender, riskLevel, monthlyContribution, years } = body;

    // Construct comprehensive Arabic prompt for detailed financial planning
    const prompt = `
أنشئ خطة مالية شاملة ومفصلة بناءً على هذه المدخلات:
الاسم: ${name}
الهدف: ${goal}
المبلغ المستهدف: ${goalAmount} ريال سعودي
العمر الحالي: ${age}
العمر المستهدف: ${targetAge}
الجنس: ${gender}
مستوى المخاطرة: ${riskLevel}
المساهمة الشهرية المقترحة: ${monthlyContribution} ريال سعودي
العملة: SAR
الأفق الزمني: ${years} سنة

**هام جداً: يجب أن تكون جميع الحسابات والتوصيات مبنية على المبلغ المستهدف المحدد (${goalAmount}) وليس أي رقم آخر.**

أريد خطة مالية شاملة ومفصلة جداً تتضمن الأقسام التالية بالتفصيل:

📋 **1. الملخص التنفيذي**
- نظرة عامة على الهدف المالي
- المبلغ المطلوب والإطار الزمني
- الاستراتيجية الرئيسية المقترحة
- النتائج المتوقعة

💰 **2. تحليل الهدف المالي**
- تحليل مفصل لطبيعة الهدف
- التكلفة المتوقعة بالتفصيل
- تأثير التضخم على التكلفة
- مقارنة بأهداف مشابهة

📈 **3. الاستراتيجية الاستثمارية المفصلة**
- توزيع الاستثمارات حسب مستوى المخاطرة
- أنواع الاستثمارات المقترحة (صناديق، أسهم، سندات، عقار)
- النسب المئوية لكل نوع استثمار
- معدلات العائد المتوقعة
- استراتيجية إعادة التوازن

💸 **4. تحليل المساهمة الشهرية**
- تفصيل المساهمة الشهرية المطلوبة
- إمكانية زيادة المساهمة سنوياً
- تأثير المساهمات الإضافية
- خيارات المساهمة المرنة
- حساب القيمة المستقبلية

📊 **5. التوقعات والإسقاطات المالية**
- جدول مفصل بالنمو السنوي للاستثمار
- سيناريوهات مختلفة (متفائل، واقعي، متحفظ)
- تأثير تقلبات السوق
- نقطة التعادل الزمنية

🏦 **6. الأدوات المالية المقترحة**
- صناديق الاستثمار السعودية المناسبة
- حسابات الادخار عالية العائد
- برامج الادخار الحكومية
- التأمين على الاستثمار

⚠️ **7. إدارة المخاطر والتحديات**
- المخاطر المحتملة وكيفية تجنبها
- استراتيجيات التنويع
- خطط الطوارئ
- التأمين ضد المخاطر الشخصية

📅 **8. الخطة الزمنية التفصيلية**
**السنة الأولى:**
- خطوات البداية الفورية
- فتح الحسابات الاستثمارية
- البدء في الاستثمار الشهري

**السنوات 2-5:**
- مراجعة الأداء كل 6 أشهر
- تعديل الاستراتيجية حسب الحاجة
- زيادة المساهمات تدريجياً

**السنوات الأخيرة:**
- تقليل المخاطر تدريجياً
- التحول للاستثمارات المحافظة
- تجهيز السيولة للهدف

🔍 **9. مؤشرات الأداء والمتابعة**
- معايير قياس نجاح الخطة
- نقاط المراجعة الدورية
- متى وكيف تعديل الخطة
- أدوات المتابعة المقترحة

📚 **10. التعليم المالي والتوعية**
- نصائح لتطوير الثقافة المالية
- موارد تعليمية للاستثمار
- كيفية تعليم الطفل قيمة المال
- إشراك الطفل في الخطة حسب عمره

🚀 **11. بدائل واستراتيجيات إضافية**
- خيارات في حالة تغير الأهداف
- استراتيجيات للأهداف المتعددة
- طرق تسريع الوصول للهدف
- خطط بديلة للطوارئ

📋 **12. قائمة المراجعة والخطوات العملية**
- قائمة تفصيلية بالخطوات المطلوبة
- المستندات والأوراق المطلوبة
- الجهات والبنوك المقترحة
- التطبيقات والأدوات المساعدة

يجب أن تكون كل نقطة مفصلة جداً مع:
- أرقام وحسابات دقيقة
- أمثلة عملية من السوق السعودي
- مراجع للأدوات المالية الفعلية
- نصائح عملية قابلة للتطبيق
- تحليلات اقتصادية واقعية

اجعل الخطة شاملة ومهنية وطويلة بما يكفي لتكون دليلاً كاملاً للاستثمار.
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: "أنت مستشار مالي خبير ومعتمد متخصص في التخطيط المالي للأطفال والأهداف طويلة المدى في المملكة العربية السعودية. لديك خبرة 20+ سنة في الأسواق المالية السعودية. قم بإنشاء خطط مالية شاملة ومفصلة ومهنية جداً باللغة العربية. يجب أن تكون الخطط طويلة وتحتوي على تحليلات عميقة وأرقام دقيقة وتوصيات عملية قابلة للتطبيق فوراً. اكتب خطة مفصلة لا تقل عن 3000 كلمة مع جداول وحسابات مالية دقيقة."
        },
        {
          role: "user",
          content: prompt
        }
      ],
      max_tokens: 16000,
      temperature: 0.7,
    });

    const planContent = completion.choices[0]?.message?.content || '';

    // Return the generated plan
    return NextResponse.json({
      success: true,
      plan: {
        name,
        goal,
        goalAmount,
        age: parseInt(age),
        targetAge: parseInt(targetAge),
        gender,
        riskLevel,
        monthlyContribution,
        years,
        content: planContent,
        generatedAt: new Date().toISOString()
      }
    });

  } catch (error) {
    console.error('Error generating financial plan:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to generate financial plan' },
      { status: 500 }
    );
  }
}